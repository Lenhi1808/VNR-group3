<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatbot — Chương 2</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#fffaf6; --card:#ffffff; --accent:#d91e18; --accent-2:#f6c11b; --rule:#ead7bb; --text:#20140f}
    *{box-sizing:border-box} body{margin:0; font-family:"Be Vietnam Pro",system-ui; background:var(--bg); color:var(--text)}
    header{position:sticky; top:0; background:#fff; border-bottom:1px solid var(--rule); padding:14px 0; z-index:5}
    .wrap{width:min(980px,92%); margin:auto; display:flex; align-items:center; justify-content:space-between; gap:12px}
    .brand{font-weight:800}
    .brand b{color:var(--accent)}
    .container{width:min(980px,92%); margin:20px auto}
    .chat{border:1px solid var(--rule); border-radius:16px; background:#fff; overflow:hidden; box-shadow:0 10px 24px rgba(0,0,0,.05)}
    .view{height:62vh; overflow:auto; padding:16px; display:grid; gap:12px; background:linear-gradient(180deg,rgba(246,193,27,.06),transparent)}
    .msg{max-width:80%; padding:12px 14px; border-radius:14px; box-shadow:0 4px 12px rgba(0,0,0,.05); animation:fade .25s ease}
    .user{margin-left:auto; background:#fff6e0; border:1px solid var(--rule)}
    .bot{background:#ffffff; border:1px solid var(--rule)}
    .cit{font-size:12px; color:#7a6a5e; margin-top:6px}
    .bar{display:flex; gap:8px; padding:12px; border-top:1px solid var(--rule); background:#fff}
    input[type=text]{flex:1; padding:12px 12px; border-radius:10px; border:1px solid var(--rule); font-size:15px}
    button{border:none; background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; padding:12px 16px; border-radius:10px; cursor:pointer}
    button:hover{filter:saturate(1.05)} button:active{transform:scale(.98)}
    .hint{color:#7a6a5e; font-size:13px; margin-top:10px}
    @keyframes fade{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
  </style>
</head>
<body>
  <header><div class="wrap"><div class="brand">Chatbot — <b>Chương 2</b></div><a href="/" style="color:var(--accent)">← Về trang chính</a></div></header>
  <main class="container">
    <div class="chat">
      <div id="view" class="view"></div>
      <div class="bar">
        <input id="q" type="text" placeholder="Nhập câu hỏi... (VD: Hiệp định Sơ bộ 6/3/1946 là gì?)" />
        <button id="send">Hỏi</button>
      </div>
    </div>
    <div class="hint">Gợi ý cấu hình: Set biến môi trường <code>UPSTREAM_API</code> trên Vercel để proxy tới API FastAPI (ví dụ: https://your-fastapi-host/ask).</div>
  </main>
  <script>
    const API = "/api/ask"; // proxy route trên Vercel
    const view = document.getElementById('view');
    const q = document.getElementById('q');
    const send = document.getElementById('send');

    function append(role, text, cites){
      const div = document.createElement('div');
      div.className = 'msg ' + (role==='user' ? 'user':'bot');
      div.innerHTML = text.replace(/\n/g,'<br>');
      if (cites && cites.length){
        const c = document.createElement('div');
        c.className='cit';
        c.textContent = 'Nguồn: ' + cites.map(x=>x.source).join(', ');
        div.appendChild(c);
      }
      view.appendChild(div);
      view.scrollTop = view.scrollHeight;
    }

    async function ask(){
      const text = q.value.trim();
      if(!text) return;
      append('user', text);
      q.value=''; q.focus();
      try{
        const r = await fetch(API, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({query:text, top_k:5})});
        if(!r.ok){ throw new Error('HTTP '+r.status); }
        const data = await r.json();
        append('bot', data.answer || '(không có trả lời)', data.citations||[]);
      }catch(e){
        append('bot', 'Xin lỗi, không kết nối được tới API. Kiểm tra cấu hình proxy / biến môi trường UPSTREAM_API trên Vercel.');
        console.error(e);
      }
    }

    send.addEventListener('click', ask);
    q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ ask(); } });
    // Pre-fill example
    append('bot', 'Xin chào! Tôi là chatbot Chương 2. Bạn có thể hỏi về các mốc 1945–1954, Hiệp định Sơ bộ 6/3/1946, Tạm ước 14–9, v.v.');
  </script>
</body>
</html>
